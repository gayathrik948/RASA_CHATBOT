let isUserLogged=!1,counter=0,canStartPolling=!1,createUUID=Math.floor(1e17+9e17*Math.random()).toString();const url="http://localhost:5005/china/webhooks/rest/",imageServerPath="./";var sessionCookie=window.mkgDL,currentToken;function chatInit(){addStyle();const chat=document.createElement("div");chat.id="xpms_container",chat.setAttribute("class","xpms_container"),document.body.appendChild(chat),createChatConatiner(),checkIfLocalStoragePresent(),checkIfUserLogggedIn(),getUserToken()}function addStyle(){const chatCss=document.createElement("link");chatCss.setAttribute("rel","stylesheet"),chatCss.setAttribute("href",imageServerPath+"chatBot.css"),document.head.appendChild(chatCss)}function createChatConatiner(){const parentElement=document.getElementById("xpms_container"),chatchild=document.createElement("div");chatchild.id="xpms_chat_bot",chatchild.style.display="none",parentElement.appendChild(chatchild);const image=document.createElement("img");image.src=imageServerPath+"logo_chat.png",image.setAttribute("id","open-icon"),image.addEventListener("click",toggleChat),parentElement.appendChild(image);const mainElement=document.getElementById("xpms_chat_bot"),chatheader=document.createElement("div");chatheader.setAttribute("id","xpms-chat-header"),chatheader.innerText="默聪聪",mainElement.appendChild(chatheader),addCloseIcon(),addRefreshIcon();const chatDiv=document.createElement("div");chatDiv.setAttribute("id","xpms-chat-container"),mainElement.appendChild(chatDiv);const inputDiv=document.createElement("div");inputDiv.setAttribute("id","chat-input"),mainElement.appendChild(inputDiv),addInputField()}function addCloseIcon(){const mainElement=document.getElementById("xpms-chat-header"),weChatImage=document.createElement("img");weChatImage.src=imageServerPath+"chatbot_magenta.png",weChatImage.setAttribute("id","header_bot_icon"),mainElement.insertAdjacentElement("afterbegin",weChatImage);const image=document.createElement("img");image.src=imageServerPath+"close.png",image.setAttribute("class","header-icon"),image.setAttribute("id","close-icon"),image.setAttribute("title","Close"),image.addEventListener("click",canCloseChat),mainElement.appendChild(image)}function addRefreshIcon(){const mainElement=document.getElementById("xpms-chat-header"),image=document.createElement("img");image.src=imageServerPath+"icon_refresh.png",image.setAttribute("class","header-icon"),image.setAttribute("id","home-icon"),image.setAttribute("title","Refresh"),image.addEventListener("click",canCloseChat),mainElement.appendChild(image)}function canCloseChat(action){localStorage&&localStorage.getItem("chatHistoryChina")&&localStorage.getItem("senderId")&&(localStorage.removeItem("senderId"),localStorage.removeItem("chatHistoryChina"));const mainDiv=document.getElementById("xpms-chat-container");for(;mainDiv.lastChild;)mainDiv.removeChild(mainDiv.lastChild);botInteraction("/reset_chat"),"home-icon"===action.target.id&&(removeQuestions(),document.getElementById("input").value="",document.getElementById("input").disabled=!0),"close-icon"===action.target.id&&toggleChat()}function checkIfUserLogggedIn(){sessionCookie&&sessionCookie.user&&sessionCookie.user.authStatus&&"logged-in"===sessionCookie.user.authStatus?(localStorage&&localStorage.getItem("chatHistoryChina")&&localStorage.getItem("senderId")&&(checkIfLocalStoragePresent(),localStorage.removeItem("senderId"),localStorage.removeItem("chatHistoryChina")),isUserLogged=!0,canStartPolling=!1):(isUserLogged=!1,canStartPolling&&setTimeout(checkIfUserLogggedIn,2e4))}function addBotChatText(input){const mainDiv=document.getElementById("xpms-chat-container"),botDiv=document.createElement("div");botDiv.id="_xpms_bot"+counter,botDiv.setAttribute("class","bot-chat talk-bubble bot-round btm-left-in"),botDiv.innerHTML+=input,mainDiv.appendChild(botDiv),appenedTimeStamp("_xpms_bot",counter,imageServerPath+"/chatbot_magenta.png","bot_icon","date_stamp_bot"),counter++,smoothScroll()}function appenedTimeStamp(id,index,path,_class,_chatClass){const currentTime=new Date,timeDiv=document.getElementById(id+index),timestamp=document.createElement("sup");timeDiv.insertAdjacentHTML("afterbegin","<img src="+path+" id='chat_icon' class="+_class+">"),timestamp.id=_chatClass,timestamp.innerText=currentTime.toLocaleTimeString(),timeDiv.appendChild(timestamp)}function addUserChatText(input){const mainDiv=document.getElementById("xpms-chat-container"),userDiv=document.createElement("div");userDiv.id="_xpms_user"+counter,userDiv.setAttribute("class","user-chat talk-bubble user-round"),userDiv.innerText=input,mainDiv.appendChild(userDiv),appenedTimeStamp("_xpms_user",counter,imageServerPath+"icon_user_circle.png","user_icon","date_stamp_user"),counter++}function botInteraction(data){const payload={message:data,sender:createUUID,metadata:{token:currentToken}};var xhr=new XMLHttpRequest;xhr.open("POST",url+"webhook",!0),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8"),xhr.onload=function(){},xhr.onreadystatechange=function(){4===xhr.readyState&&(xhr.status>=200&&xhr.status<300&&JSON.parse(xhr.responseText).length>0?(createDomSuggestion(JSON.parse(xhr.responseText)),smoothScroll()):addBotChatText("抱歉！我无法检索信息，请稍后重试"))},xhr.send(JSON.stringify(payload)),xhr.onloadend=function(){0==xhr.status&&addBotChatText("抱歉！我无法检索信息，请稍后重试")}}function getUserToken(){var payload;sessionCookie&&sessionCookie.user&&(payload={user:sessionCookie.user});var xhr=new XMLHttpRequest;xhr.open("POST",url+"token",!0),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8"),xhr.onload=function(){},xhr.onreadystatechange=function(){4===xhr.readyState&&(xhr.status>=200&&xhr.status<300?currentToken=JSON.parse(xhr.responseText):addBotChatText("抱歉！我无法检索信息，请稍后重试"))},xhr.send(JSON.stringify(payload)),xhr.onloadend=function(){0==xhr.status&&addBotChatText("抱歉！我无法检索信息，请稍后重试")}}function createDomSuggestion(response){if(response.length>0)for(let i=0;i<response.length;i++){if(response[i].text&&addBotChatText(response[i].text),response[i].buttons&&response[i].buttons.length>0){const userDiV=document.getElementById("xpms-chat-container"),buttonDiv=document.createElement("div");buttonDiv.setAttribute("id","custom-button");for(let j=0;j<response[i].buttons.length;j++){const newChild=document.createElement("button");newChild.setAttribute("class","child-button round"),newChild.setAttribute("id","child-button-key"),newChild.setAttribute("payload",response[i].buttons[j].payload),newChild.innerText=response[i].buttons[j].title,response[i].buttons[j].href&&newChild.setAttribute("href",response[i].buttons[j].href),newChild.addEventListener("click",onButtonClick),buttonDiv.appendChild(newChild)}userDiV.appendChild(buttonDiv)}if(response[i].custom&&createDomSuggestion(response[i].custom),!0===response[i].enable_textbox&&(document.getElementById("input").disabled=!1),!0===response[i].store_conversation){const chatHistory=document.getElementById("xpms-chat-container");localStorage.setItem("chatHistoryChina",chatHistory.innerHTML),localStorage.setItem("senderId",createUUID),canStartPolling=!0,checkIfUserLogggedIn()}}}function onButtonClick(e){const selectedData=e.target.getAttribute("payload"),url=e.target.getAttribute("href");if(url)window.open(url,"_blank");else{const mainDiv=document.getElementById("xpms-chat-container");mainDiv.removeChild(mainDiv.lastChild),botInteraction(selectedData),addUserChatText(selectedData)}}function askQuestions(data){const payload={message:data,sender:createUUID};if(""!==data&&null!=data){var xhr=new XMLHttpRequest;xhr.open("POST",url+"questions",!0),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8"),xhr.onreadystatechange=function(){4===xhr.readyState&&(xhr.status>=200&&xhr.status<300?appendQuestions(JSON.parse(xhr.responseText)):appendQuestions({questions:["我的问题不在这里"]}))},xhr.send(JSON.stringify(payload)),xhr.onloadend=function(){0==xhr.status&&addBotChatText("抱歉！我无法检索信息，请稍后重试")}}}function appendQuestions(data){const chatDiv=document.getElementById("chat-input"),chatinDiV=document.createElement("div");chatinDiV.setAttribute("id","question"),chatDiv.appendChild(chatinDiV),removeQuestions();for(let i=0;i<data.questions.length;i++){const userDiV=document.getElementById("question"),quesDiv=document.createElement("div");quesDiv.setAttribute("class","response-question round"),quesDiv.setAttribute("value",data.questions[i]),quesDiv.innerText=data.questions[i],quesDiv.addEventListener("click",onQuestionClick),userDiV.appendChild(quesDiv)}}function onQuestionClick(e){const text=e.target.innerText;removeInput(),addUserChatText(text),botInteraction(text),document.getElementById("input").disabled=!0;const myQuestion=document.getElementById("question");myQuestion.parentNode.removeChild(myQuestion)}function addInputField(){const mainDiv=document.getElementById("chat-input"),inputDiv=document.createElement("input");inputDiv.id="input",inputDiv.setAttribute("placeholder","请输入"),inputDiv.setAttribute("class","round"),inputDiv.addEventListener("input",debounce(onInputQuestion,2e3)),inputDiv.addEventListener("input",checkInput),mainDiv.appendChild(inputDiv),document.getElementById("input").disabled=!0;const imageIcon=document.createElement("img");imageIcon.id="remove_input",imageIcon.setAttribute("src",imageServerPath+"chat_remove.png"),imageIcon.addEventListener("click",removeInput),mainDiv.appendChild(imageIcon)}function debounce(func,wait){let timeout;return function(args){const context=this,executor=function(){timeout=null,func.apply(context,args)};clearTimeout(timeout),timeout=setTimeout(executor,wait)}}function onInputQuestion(e){const key=document.getElementById("input").value;return new Promise((function(resolve){setTimeout((function(){resolve(askQuestions(key))}))}))}function smoothScroll(){const mainDiv=document.getElementById("xpms-chat-container");mainDiv.lastChild&&mainDiv.lastChild.scrollIntoView(!1)}function toggleChat(){const mainDiv=document.getElementById("xpms_chat_bot"),clickIcon=document.getElementById("open-icon");"none"===mainDiv.style.display?(mainDiv.style.display="block",clickIcon.style.display="none"):(mainDiv.style.display="none",clickIcon.style.display="block",localStorage&&localStorage.getItem("chatHistoryChina")&&localStorage.getItem("senderId")&&(localStorage.removeItem("senderId"),localStorage.removeItem("chatHistoryChina")))}function checkIfLocalStoragePresent(){if(localStorage&&localStorage.getItem("chatHistoryChina")&&localStorage.getItem("senderId")){const storedChatHistory=localStorage.getItem("chatHistoryChina");document.getElementById("xpms-chat-container").innerHTML+=storedChatHistory;const senderID=localStorage.getItem("senderId");createUUID=senderID;const conatinerDiv=document.getElementById("xpms_chat_bot");conatinerDiv.style.display="block";const clickIcon=document.getElementById("open-icon");clickIcon.style.display="none",appendEventListener(),setTimeout(smoothScroll,1e3)}else botInteraction("/greet")}function appendEventListener(){const item=document.querySelectorAll("#child-button-key");for(i=0;i<item.length;i++)item[i].addEventListener("click",onButtonClick)}function removeQuestions(){const childDiv=document.getElementById("question");for(;childDiv&&childDiv.lastChild;)childDiv.removeChild(childDiv.lastChild)}function removeInput(){removeQuestions(),document.getElementById("input").value="",checkInput()}function checkInput(){const userInput=document.getElementById("input"),closeIcon=document.getElementById("remove_input");if(userInput&&(""!==userInput.value?closeIcon.style.display="block":(closeIcon.style.display="none",removeQuestions()),""==userInput.value)){const myQuestion=document.getElementById("question");myQuestion.parentNode.removeChild(myQuestion)}}window.onload=new function(){chatInit()};